# Exact Rank-2 Acceleration of MAG1C Methane Retrieval

**Cesar Aybar** · **Julio Contreras** · **Luis Gómez-Chova**

*Image and Signal Processing Group, Universitat de València*

---

MAG1C is the standard algorithm for retrieving methane column enhancements from imaging spectrometers such as PRISMA, EnMAP, and EMIT. Its iterative filter refines the background covariance by subtracting the current methane estimate at each step, preventing plume contamination but requiring an O(Ns²) matrix product per iteration that dominates runtime. We show this update admits an exact rank-2 decomposition, with a fixed base covariance precomputed once and a correction computable in O(Ns) per iteration. The reformulation is algebraically exact in float64 and introduces negligible sub-ppm·m error in float32.

**Paper:** *Algebraically Exact Rank-2 Acceleration of MAG1C Methane Retrieval* (IEEE GRSL, submitted)

## Installation

```bash
pip install methanex
```

Or from source:

```bash
git clone https://github.com/csaybar/fastmag1c.git
cd fastmag1c
pip install -e .
```

## CH₄ absorption template

`methanex` uses a precomputed CH₄ absorption template stored as a [safetensors](https://huggingface.co/docs/safetensors) file. This template is generated by convolving a MODTRAN radiative transfer look-up table with the EMIT instrument spectral response function, producing a unit absorption spectrum across all 285 bands. At runtime, the engine selects the 50 SWIR bands in the 2122–2488 nm window and scales the template by the per-column mean radiance to obtain the albedo-corrected target signature τ = t ⊙ μ.

The file is hosted at [Source Cooperative](https://data.source.coop/taco/methaneset/ch4_emit.safetensors) and downloaded automatically to `~/.cache/methanex/` on first use. It contains two tensors: `centers` (285 central wavelengths in nm) and `template` (285 unit absorption values).

## Quick start

```python
import torch
from methanex import MethaneRetrieval, MAG1CFastConfig

# rad: (downtrack, crosstrack, bands) — SWIR bands in 2122–2488 nm
rad = torch.from_numpy(rad_swir)

eng = MethaneRetrieval(device="cuda")
result = eng.retrieve(rad, MAG1CFastConfig(batch_size=64))

mf = result.mf          # methane column enhancement (ppm·m)
albedo = result.albedo   # per-pixel albedo
meta = result.metadata   # diagnostics
```

## Retrieval methods

`methanex` exposes four matched filter variants through a unified `eng.retrieve()` API — pass a different config to switch method:

| Config | Method | Description |
|---|---|---|
| `MFConfig` | Basic MF | No albedo correction |
| `RMFConfig` | Albedo-corrected MF | Single-pass with per-pixel albedo normalization |
| `MAG1CConfig` | MAG1C (reference) | Iterative sparse filter, O(K·N·s²) covariance per column |
| `MAG1CFastConfig` | MAG1C-fast (ours) | Rank-2 accelerated, O(N·s²) + O(K·N·s) covariance per column |

All methods return a `RetrievalResult` that supports both named access and tuple unpacking:

```python
mf, albedo, meta = eng.retrieve(rad, config)
```

### Key parameters

```python
# Reference MAG1C
MAG1CConfig(
    batch_size=64,       # columns processed in parallel on GPU
    num_iter=30,         # reweighted-L1 iterations (K)
    alpha=1e-4,          # diagonal regularization weight
)

# Rank-2 accelerated (same output, faster)
MAG1CFastConfig(
    batch_size=64,
    num_iter=30,
    alpha=1e-4,
    tol=1e-5,            # early stopping on relative mf change (None = disabled)
)
```

`batch_size` controls how many independent CCD columns run in parallel. Each column keeps its own statistics (`column_step=1`), but multiple columns share a single kernel launch. For EMIT on a T4 GPU, `batch_size=64` is a good default.

## Demo: methane retrieval on EMIT

Copy-paste and run. Downloads the EMIT L1B granule (~1.7 GB), selects the SWIR bands, and runs the rank-2 accelerated retrieval:

```python
import subprocess
subprocess.run(["pip", "install", "-q", "methanex", "gdown", "xarray", "netcdf4"])

import gdown
import xarray as xr
import numpy as np
import torch
from methanex import MethaneRetrieval, MAG1CFastConfig

# download EMIT L1B granule (20240604T140353, eastern Black Sea)
gdown.download(id="1HXoShWwS5EVy98BOAybSkPq4EuVVqwI3", quiet=False)
FILE = "EMIT_L1B_RAD_001_20240604T140353_2415609_030.nc"

# load radiance and select SWIR CH4 window (2122–2488 nm, 50 bands)
ds  = xr.open_dataset(FILE)
sbp = xr.open_dataset(FILE, group="sensor_band_parameters")
rad = ds["radiance"].values                          # (2528, 1242, 285)
wvl = sbp["wavelengths"].values
mask = (wvl >= 2122) & (wvl <= 2488)
rad_swir = torch.from_numpy(rad[:, :, mask])         # (2528, 1242, 50)

# run retrieval
eng = MethaneRetrieval(device="cuda", dtype=torch.float64)
result = eng.retrieve(rad_swir, MAG1CFastConfig(batch_size=64))

# result.mf is (2528, 1242) in ppm·m
# pixels > 500 ppm·m are candidate plume pixels
plume_mask = result.mf > 500
print(f"Plume pixels: {plume_mask.sum().item()}")
```

To download EMIT granules directly from NASA's archive instead of Google Drive, see [georeader](https://github.com/spaceml-org/georeader).

## Citation

```bibtex
@article{aybar2025fastmag1c,
  title={Algebraically Exact Rank-2 Acceleration of MAG1C Methane Retrieval},
  author={Aybar, Cesar and Contreras, Julio and G{\'o}mez-Chova, Luis},
  journal={IEEE Geoscience and Remote Sensing Letters},
  year={2025},
  note={Submitted}
}
```

## License

MIT
